<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test View Project Tabs</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Test View Project Tab Navigation</h2>
        
        <div class="alert alert-warning">
            <strong>Simulation Test:</strong> This simulates the exact tab structure from view_project.php
        </div>
        
        <!-- Exact same tab structure as view_project.php -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt mr-2"></i>Tài liệu liên quan</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="documentTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="proposal-tab" data-toggle="tab" href="#proposal" role="tab">
                            <i class="fas fa-file-alt mr-1"></i> Thuyết minh
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="contract-tab" data-toggle="tab" href="#contract" role="tab">
                            <i class="fas fa-file-contract mr-1"></i> Hợp đồng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="decision-tab" data-toggle="tab" href="#decision" role="tab">
                            <i class="fas fa-file-signature mr-1"></i> Quyết định
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="report-tab" data-toggle="tab" href="#report" role="tab">
                            <i class="fas fa-file-invoice mr-1"></i> Biên bản
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="evaluation-tab" data-toggle="tab" href="#evaluation" role="tab">
                            <i class="fas fa-clipboard-check mr-1"></i> Đánh giá
                        </a>
                    </li>
                </ul>
                
                <div class="tab-content" id="documentTabsContent">
                    <div class="tab-pane fade show active" id="proposal" role="tabpanel" aria-labelledby="proposal-tab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Tab Thuyết minh</h5>
                                <p>Nội dung tab thuyết minh...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="contract" role="tabpanel" aria-labelledby="contract-tab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Tab Hợp đồng</h5>
                                <p>Nội dung tab hợp đồng...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="decision" role="tabpanel" aria-labelledby="decision-tab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Tab Quyết định nghiệm thu</h5>
                                <p>Nội dung tab quyết định...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="report" role="tabpanel" aria-labelledby="report-tab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Tab Biên bản nghiệm thu</h5>
                                <p><strong>ĐÂY LÀ TAB SẼ ĐƯỢC ACTIVE SAU KHI CẬP NHẬT THÀNH VIÊN HỘI ĐỒNG</strong></p>
                                
                                <!-- Simulate council member form -->
                                <form id="testCouncilForm">
                                    <div class="form-group">
                                        <label>Test Council Members Update:</label>
                                        <input type="text" class="form-control" value="Test council update">
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-users mr-1"></i>Simulate Council Update
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="evaluation" role="tabpanel" aria-labelledby="evaluation-tab">
                        <div class="card">
                            <div class="card-body">
                                <h5>Tab Đánh giá</h5>
                                <p>Nội dung tab đánh giá...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="card mt-4">
            <div class="card-header">Test Controls</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Manual Tab Activation:</h6>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="activateTab('proposal')">Thuyết minh</button>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="activateTab('contract')">Hợp đồng</button>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="activateTab('decision')">Quyết định</button>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="activateTab('report')">Biên bản</button>
                        <button class="btn btn-sm btn-outline-primary mr-2" onclick="activateTab('evaluation')">Đánh giá</button>
                    </div>
                    <div class="col-md-6">
                        <h6>URL Tests:</h6>
                        <button class="btn btn-sm btn-outline-success mr-2" onclick="setUrlTab('report')">Set URL ?tab=report</button>
                        <button class="btn btn-sm btn-outline-info mr-2" onclick="reloadPage()">Reload Page</button>
                    </div>
                </div>
                
                <hr>
                
                <div id="debugOutput" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace;">
                    Debug output will appear here...
                </div>
            </div>
        </div>
    </div>

    <!-- Load same libraries as view_project.php -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(message);
        }
        
        $(document).ready(function() {
            debugLog('Document ready - starting tab initialization');
            initializeTabs();
            
            // Test form submission
            $('#testCouncilForm').on('submit', function(e) {
                e.preventDefault();
                debugLog('Form submitted - simulating redirect to ?tab=report');
                
                // Simulate the redirect
                setUrlTab('report');
                initializeTabs();
            });
        });

        // EXACT SAME FUNCTION AS IN view_project.php
        function initializeTabs() {
            debugLog('Initializing tabs...');
            
            // Remove all existing event handlers to prevent conflicts
            $('a[data-toggle="tab"]').off('click show.bs.tab shown.bs.tab');
            
            // Get tab from URL parameter or sessionStorage
            var urlParams = new URLSearchParams(window.location.search);
            var urlTab = urlParams.get('tab');
            var sessionTab = sessionStorage.getItem('activeTab');
            var activeTab = urlTab || sessionTab || 'proposal';
            
            debugLog('Target tab: ' + activeTab);
            
            // Restore active tab if it exists
            if (activeTab && $('#' + activeTab).length) {
                debugLog('Activating tab: ' + activeTab);
                
                // Remove active from all tabs and content
                $('.nav-tabs .nav-link').removeClass('active');
                $('.tab-pane').removeClass('show active');
                
                // Activate the correct tab and content
                $('a[href="#' + activeTab + '"]').addClass('active');
                $('#' + activeTab).addClass('show active');
                
                // Store in sessionStorage
                sessionStorage.setItem('activeTab', activeTab);
            }
            
            // Handle tab clicks with a single, simple event handler
            $('a[data-toggle="tab"]').on('click', function(e) {
                e.preventDefault();
                debugLog('Tab clicked: ' + $(this).attr('href'));
                
                var target = $(this).attr('href');
                var tabName = target.substring(1);
                
                // Remove active from all tabs and content
                $('.nav-tabs .nav-link').removeClass('active');
                $('.tab-pane').removeClass('show active');
                
                // Activate clicked tab and content
                $(this).addClass('active');
                $(target).addClass('show active');
                
                // Store in sessionStorage
                sessionStorage.setItem('activeTab', tabName);
                
                // Update URL without reload
                if (history.pushState) {
                    var currentUrl = window.location.pathname + window.location.search;
                    var newUrl = currentUrl.replace(/[?&]tab=[^&]*/, '');
                    newUrl += (newUrl.includes('?') ? '&' : '?') + 'tab=' + tabName;
                    history.pushState(null, null, newUrl);
                }
                
                debugLog('Tab activated: ' + tabName);
            });
            
            debugLog('Tab initialization complete');
        }
        
        function activateTab(tabName) {
            debugLog('Manual activation: ' + tabName);
            $('a[href="#' + tabName + '"]').click();
        }
        
        function setUrlTab(tabName) {
            const newUrl = window.location.pathname + '?tab=' + tabName;
            history.pushState(null, null, newUrl);
            debugLog('URL updated to: ' + newUrl);
        }
        
        function reloadPage() {
            window.location.reload();
        }
    </script>
</body>
</html>
